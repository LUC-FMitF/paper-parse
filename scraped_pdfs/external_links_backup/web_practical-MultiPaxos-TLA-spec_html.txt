Source URL: https://www.josehu.com/technical/2024/02/19/practical-MultiPaxos-TLA-spec.html
Final URL: https://www.josehu.com/technical/2024/02/19/practical-MultiPaxos-TLA-spec.html
================================================================================

<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Practical SMR-style TLA+ Specification of the MultiPaxos Protocol | Guanzhou Hu</title>
<meta name="generator" content="Jekyll v3.10.0" />
<meta property="og:title" content="Practical SMR-style TLA+ Specification of the MultiPaxos Protocol" />
<meta name="author" content="Guanzhou Hu" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="The attached files present a practical TLA+ specification of MultiPaxos that very closely models how a real state machine replication (SMR) system would implement this protocol. I did not find anything similar on the web, so Iâ€™d like to share it with anyone interested." />
<meta property="og:description" content="The attached files present a practical TLA+ specification of MultiPaxos that very closely models how a real state machine replication (SMR) system would implement this protocol. I did not find anything similar on the web, so Iâ€™d like to share it with anyone interested." />
<link rel="canonical" href="https://www.josehu.com/technical/2024/02/19/practical-MultiPaxos-TLA-spec.html" />
<meta property="og:url" content="https://www.josehu.com/technical/2024/02/19/practical-MultiPaxos-TLA-spec.html" />
<meta property="og:site_name" content="Guanzhou Hu" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2024-02-19T12:11:20+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Practical SMR-style TLA+ Specification of the MultiPaxos Protocol" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Guanzhou Hu"},"dateModified":"2024-02-19T12:11:20+00:00","datePublished":"2024-02-19T12:11:20+00:00","description":"The attached files present a practical TLA+ specification of MultiPaxos that very closely models how a real state machine replication (SMR) system would implement this protocol. I did not find anything similar on the web, so Iâ€™d like to share it with anyone interested.","headline":"Practical SMR-style TLA+ Specification of the MultiPaxos Protocol","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.josehu.com/technical/2024/02/19/practical-MultiPaxos-TLA-spec.html"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://www.josehu.com/assets/img/Gravatar_Sedona-sq.jpg"},"name":"Guanzhou Hu"},"url":"https://www.josehu.com/technical/2024/02/19/practical-MultiPaxos-TLA-spec.html"}</script>
<!-- End Jekyll SEO tag -->

  <link rel="stylesheet" href="/assets/css/style.css?v=04f110fb6dab3d5db33e64585e10ccfe915ab148">
  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
  <![endif]-->

  <!-- Favicon -->
  <link rel="icon" href="/assets/img/favicon.png" type="image/png">

  <!-- For MathJax -->
  
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-MML-AM_CHTML"></script>
  
</head>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-K6XTLWGSJS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-K6XTLWGSJS');
</script>

<body>
  <div class="wrapper">
    <header>
      <div id="header-upper">
        <h1 id="site-title-box">
          <a id="site-title" href="https://www.josehu.com/">Guanzhou Hu</a>
        </h1>

        
        <span id="site-logo-box">
          <img id="site-logo" src="/assets/img/Gravatar_Sedona-sq.jpg" alt="Logo" />
        </span>
        

        <p id="site-description">
          Feeling comfortably numb
          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-lightning-charge" viewBox="0 0 16 16">
            <path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09zM4.157 8.5H7a.5.5 0 0 1 .478.647L6.11 13.59l5.732-6.09H9a.5.5 0 0 1-.478-.647L9.89 2.41 4.157 8.5z" />
          </svg>
        </p>
      </div>

      <div id="header-lower">
        <p class="view" id="github-link">
          <a href="https://github.com/josehu07" target="_blank">
            Find me on GitHub<br>
            <small>https://github.com/josehu07</small>
          </a>
        </p>

        <p class="view">
          <a href="/assets/file/Guanzhou_Hu_CV.pdf" target="_blank">CV</a>&nbsp;|&nbsp;<a href="https://www.linkedin.com/in/josehu" target="_blank">LinkedIn</a>&nbsp;|&nbsp;<a href="https://scholar.google.com/citations?hl=en&user=CXWO_egAAAAJ" target="_blank">G Scholar</a><br>
        </p>

        <p class="view">
        <table class="sidebar-table">
          <tr class="sidebar-table">
            <td class="sidebar-table sidebar-table-icon" rowspan="2">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope" viewBox="0 0 16 16">
                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4Zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2Zm13 2.383-4.708 2.825L15 11.105V5.383Zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741ZM1 11.105l4.708-2.897L1 5.383v5.722Z" />
              </svg>
            </td>
            <td class="sidebar-table">josehgz (at) amazon.com</td>
          </tr>
          <tr class="sidebar-table">
            <td class="sidebar-table">guanzhou.hu (at) wisc.edu</td>
          </tr>
        </table>
        </p>
      </div>

      <p id="header-bottom">
        <small>To all my loved ones, cheers â™¥</small><br>
        <small>Theme adapted from <a href="https://github.com/orderedlist" target="_blank">orderedlist</a></small>
      </p>
    </header>

    <section>

      <h1>Practical SMR-style TLA+ Specification of the MultiPaxos Protocol</h1>
<p>19 Feb 2024 - Guanzhou Hu</p>

<p class="navigation-bar-blog-back">
  <a href="/blogs.html">Back to List of Blogs</a>
</p>

<p>The attached files present a practical TLA+ specification of MultiPaxos that very closely models how a real state machine replication (SMR) system would implement this protocol. I did not find anything similar on the web, so Iâ€™d like to share it with anyone interested.</p>

<h2 id="files-of-this-tla-spec">Files of This TLA+ Spec</h2>

<p>Below are the files composing the checkable model (organized in VSCode extension style):</p>

<ul>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_style/MultiPaxos.tla">MultiPaxos.tla</a> (main protocol spec written in PlusCal and with translation attached)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_style/MultiPaxos_MC.tla">MultiPaxos_MC.tla</a> (entrance of running model checking; contains the checked constraints)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_style/MultiPaxos_MC.cfg">MultiPaxos_MC.cfg</a> (recommended model inputs and configurations, which should give 100% coverage of all interesting cases)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_style/MultiPaxos_MC_small.cfg">MultiPaxos_MC_small.cfg</a> (smaller input with one fewer write and no <code class="language-plaintext highlighter-rouge">CommitNotice</code> messages)</li>
</ul>

<h2 id="whats-good-about-this-spec">Whatâ€™s Good About This Spec</h2>

<p>This spec is different from traditional, general descriptions of Paxos/MultiPaxos in the following aspects:</p>

<ul>
  <li>It models MultiPaxos in a practical SMR system style thatâ€™s much closer to real implementations than its traditional, abstract specs (e.g., <a href="https://github.com/tlaplus/Examples/tree/master/specifications/Paxos">this</a>)
    <ul>
      <li>All servers explicitly replicate a log of instances, each holding a command</li>
      <li>Numbers of client write/read commands are made model inputs</li>
      <li>Explicit <em>termination</em> condition is defined, thus semi-liveness can be checked by not having deadlocks</li>
      <li>Safety constraint is defined as a clean client-viewed <em>linearizability</em> property upon termination</li>
      <li>Replica node failure is injected to assure the protocolâ€™s fault-tolerance level</li>
      <li>See the detailed comments in the source filesâ€¦</li>
    </ul>
  </li>
  <li>Careful optimizations are applied to the spec to reduce the state space W.L.O.G.
    <ul>
      <li>Model checking with recommended inputs completes in &lt; 22 min on a 40-core server machine</li>
      <li>Commenting out the <code class="language-plaintext highlighter-rouge">HandleCommitNotice</code> action (which is the least significant) and having one fewer request reduces check time down to &lt; 10 secs</li>
    </ul>
  </li>
  <li>It is easy to extend this spec and add even more practical features
    <ul>
      <li>Leader lease and local read</li>
      <li>Asymmetric write/read quorum sizes</li>
      <li>â€¦</li>
    </ul>
  </li>
</ul>

<p>This spec has been accepted into the official <a href="https://github.com/tlaplus/Examples">TLA+ Examples repo</a>! <sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup></p>

<p>Here are some links I found particularly useful when developing this spec by myself: <sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup> <sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">3</a></sup> <sup id="fnref:4" role="doc-noteref"><a href="#fn:4" class="footnote" rel="footnote">4</a></sup> <sup id="fnref:5" role="doc-noteref"><a href="#fn:5" class="footnote" rel="footnote">5</a></sup></p>

<h2 id="update-extended-spec-with-extra-features">Update: Extended Spec with Extra Features</h2>

<p>Below are the files composing an extended version of the spec along with model inputs:</p>

<ul>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_addon/MultiPaxos.tla">MultiPaxos.tla</a> (extended main protocol spec written in PlusCal and with translation attached)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_addon/MultiPaxos_MC.tla">MultiPaxos_MC.tla</a> (entrance of running model checking; contains the checked constraints)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_addon/MultiPaxos_MC.cfg">MultiPaxos_MC.cfg</a> (recommended model inputs and configurations, which should give 100% coverage of all interesting cases with default features)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_addon/MultiPaxos_MC_small.cfg">MultiPaxos_MC_small.cfg</a> (smallest input for sanity check)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_addon/MultiPaxos_MC_rwqrm.cfg">MultiPaxos_MC_rwqrm.cfg</a> (input demonstrating asymmetric write/read quorum sizes)</li>
  <li><a href="/assets/file/tla-specs/multipaxos_smr_addon/MultiPaxos_MC_lease.cfg">MultiPaxos_MC_lease.cfg</a> (input demonstrating stable leader leases and local read)</li>
</ul>

<h2 id="whats-new-in-the-extended-spec">Whatâ€™s New in the Extended Spec</h2>

<p>The extended spec includes the following extra features/variants of MultiPaxos that are very essential and useful in practice:</p>

<ul>
  <li>Only keep writes in the log (while reads squeeze in between writes)</li>
  <li>Asymmetric write/read quorum sizes</li>
  <li>Stable leader lease and local read at leader</li>
</ul>

<h2 id="references">References</h2>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://github.com/tlaplus/Examples">https://github.com/tlaplus/Examples</a>Â <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://lamport.azurewebsites.net/tla/tutorial/home.html">https://lamport.azurewebsites.net/tla/tutorial/home.html</a>Â <a href="#fnref:2" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://learntla.com/index.html">https://learntla.com/index.html</a>Â <a href="#fnref:3" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:4" role="doc-endnote">
      <p><a href="https://lamport.azurewebsites.net/tla/summary-standalone.pdf">https://lamport.azurewebsites.net/tla/summary-standalone.pdf</a>Â <a href="#fnref:4" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
    <li id="fn:5" role="doc-endnote">
      <p><a href="https://tla.msr-inria.inria.fr/tlatoolbox/doc/model/distributed-mode.html">https://tla.msr-inria.inria.fr/tlatoolbox/doc/model/distributed-mode.html</a>Â <a href="#fnref:5" class="reversefootnote" role="doc-backlink">&#8617;</a></p>
    </li>
  </ol>
</div>


<p class="navigation-bar-blog-back">
  <a href="/blogs.html">Back to List of Blogs</a>
</p>


<p class="comments-welcome"><strong>Comments welcome! ðŸ˜‰</strong></p>


      <!-- For Utterance comments -->
      <script src="https://utteranc.es/client.js"
              repo="josehu07/josehu07.github.io"
              issue-term="pathname"
              label="UtterancesðŸ”®"
              theme="github-light"
              crossorigin="anonymous"
              async>
      </script>

      <p class="navigation-bar">
        <script type="text/javascript">
          function topFunction() {
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
          }
        </script>
        <a href="javascript:topFunction();">Back to Top</a>
      </p>

    </section>
  </div>

  <script src="/assets/js/scale.fix.js"></script>
</body>

</html>